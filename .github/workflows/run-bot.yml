name: Run Telegram Bot on GitHub Actions

on:
  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦šà¦¾à¦²à¦¾à¦¤à§‡
  workflow_dispatch:
  
  # à¦¨à¦¿à¦°à§à¦¦à¦¿à¦·à§à¦Ÿ à¦¸à¦®à¦¯à¦¼à§‡ à¦šà¦¾à¦²à¦¾à¦¤à§‡ (cron job)
  schedule:
    # à¦ªà§à¦°à¦¤à¦¿ à¦˜à¦¨à§à¦Ÿà¦¾à¦¯à¦¼ à¦šà§‡à¦• à¦•à¦°à¦¬à§‡
    - cron: '0 * * * *'
    
  # à¦•à§‹à¦¡ à¦ªà§à¦¶ à¦¹à¦²à§‡ à¦šà¦¾à¦²à¦¾à¦¤à§‡
  push:
    branches: [ main ]
    
  # à¦ªà§à¦² à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿà§‡ à¦šà¦¾à¦²à¦¾à¦¤à§‡
  pull_request:
    branches: [ main ]

jobs:
  run-bot:
    name: Run Telegram Bot
    runs-on: ubuntu-latest
    timeout-minutes: 60  # à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š à§§ à¦˜à¦¨à§à¦Ÿà¦¾ à¦šà¦²à¦¬à§‡
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        echo "âœ… Dependencies installed"
        
    - name: Create config.json from secret
      run: |
        echo "ðŸ”§ Creating config.json..."
        cat > config.json << EOF
        {
          "bot": {
            "token": "${{ secrets.BOT_TOKEN }}",
            "username": "group_master_bot",
            "name": "Group Master",
            "version": "3.0.0",
            "mode": "polling"
          },
          "developers": [${{ secrets.DEVELOPER_ID }}],
          "owners": [${{ secrets.OWNER_ID }}],
          "features": {
            "welcome_system": true,
            "auto_reply": true,
            "moderation": true,
            "broadcast": true,
            "games": true,
            "ai_chat": false,
            "image_generation": false
          },
          "security": {
            "blocked_users": [],
            "blocked_groups": []
          },
          "limits": {
            "messages_per_minute": 30,
            "welcome_messages_limit": 10
          },
          "auto_reply": {
            "typing_delay_ms": 1000,
            "reply_delay_ms": 2000
          }
        }
        EOF
        echo "âœ… Config file created"
        
    - name: Create data directories
      run: |
        echo "ðŸ“ Creating data structure..."
        mkdir -p data/responses data/moderation data/welcome data/system
        mkdir -p assets/backgrounds
        
        # Create default files if they don't exist
        if [ ! -f "data/responses/auto-reply.json" ]; then
          cat > data/responses/auto-reply.json << EOF
          {
            "hi": ["Hello! ðŸ‘‹", "Hi there! ðŸ˜Š", "Assalamualaikum! ðŸ¤²"],
            "how are you": ["I'm fine, thank you! ðŸ˜Š", "Alhamdulillah, I'm good! ðŸŒŸ"],
            "thank you": ["You're welcome! ðŸ˜Š", "My pleasure! ðŸŒŸ"],
            "bye": ["Goodbye! ðŸ‘‹", "Take care! ðŸ˜Š"]
          }
          EOF
        fi
        
        if [ ! -f "data/moderation/bad-words.json" ]; then
          echo '["badword", "curse", "à¦…à¦ªà¦¶à¦¬à§à¦¦"]' > data/moderation/bad-words.json
        fi
        
        if [ ! -f "data/welcome/templates.json" ]; then
          cat > data/welcome/templates.json << EOF
          {
            "group": ["ðŸŽ‰ Welcome {name} to {group}! ðŸŒŸ"],
            "private": ["ðŸ‘‹ Hello {name}! I'm Group Master Bot! ðŸ¤–"]
          }
          EOF
        fi
        
        echo "âœ… Data structure created"
        
    - name: Run the bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "ðŸš€ Starting Telegram Bot..."
        echo "ðŸ¤– Bot will run for maximum 55 minutes"
        echo "ðŸ“± Mode: Polling"
        echo "â° Started at: $(date)"
        
        # Start the bot in background with timeout
        timeout 55m npm start &
        BOT_PID=$!
        
        # Wait for bot process
        wait $BOT_PID
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 124 ]; then
          echo "ðŸ•’ Bot stopped after 55 minutes (GitHub Actions timeout)"
        elif [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… Bot stopped normally"
        else
          echo "âŒ Bot stopped with error code: $EXIT_CODE"
        fi
        
    - name: Send notification on failure
      if: failure()
      run: |
        echo "âŒ Bot run failed!"
        # à¦à¦–à¦¾à¦¨à§‡ à¦†à¦ªà¦¨à¦¿ à¦Ÿà§‡à¦²à¦¿à¦—à§à¦°à¦¾à¦® à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦¯à§‹à¦— à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¦¨
        # curl à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦¨à§à¦¯ à¦à¦•à¦Ÿà¦¿ à¦¬à¦Ÿ à¦¦à¦¿à§Ÿà§‡ à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¦¨
        
    - name: Upload logs (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-logs
        path: |
          logs/
          *.log
        retention-days: 7
