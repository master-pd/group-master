name: Run Telegram Bot

on:
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ö‡¶æ‡¶≤‡¶æ‡¶§‡ßá
  schedule:
    # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß©‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá ‡¶ö‡¶æ‡¶≤‡¶æ‡¶¨‡ßá (‡ß®‡ß™/‡ß≠ ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
    - cron: '*/30 * * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 29  # ‡ß©‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∂‡ßá‡¶∑ ‡¶π‡¶¨‡ßá
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate package-lock.json if missing
      run: |
        echo "üîß Checking for package-lock.json..."
        if [ ! -f "package-lock.json" ]; then
          echo "üì¶ Generating package-lock.json..."
          npm init -y
          npm install node-telegram-bot-api canvas axios moment lodash chalk winston
          echo "‚úÖ package-lock.json created"
        else
          echo "‚úÖ package-lock.json exists"
        fi
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        # ‡¶Ø‡¶¶‡¶ø package-lock.json ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶æ‡¶π‡¶≤‡ßá ci ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
        echo "‚úÖ Dependencies installed"
        
    - name: Create config file
      run: |
        echo "‚öôÔ∏è Creating config.json..."
        cat > config.json << 'EOF'
        {
          "bot": {
            "token": "${{ secrets.BOT_TOKEN }}",
            "username": "group_master_bot",
            "name": "Group Master",
            "version": "3.0.0"
          },
          "developers": [123456789],
          "owners": [123456789],
          "features": {
            "welcome_system": true,
            "auto_reply": true,
            "moderation": true
          }
        }
        EOF
        echo "‚úÖ Config file created"
        
    - name: Create required directories
      run: |
        echo "üìÅ Creating directories..."
        mkdir -p data/responses data/moderation data/welcome data/system
        mkdir -p assets/backgrounds
        echo "‚úÖ Directories created"
        
    - name: Create default data files
      run: |
        echo "üìù Creating default data files..."
        
        # Auto-reply responses
        cat > data/responses/auto-reply.json << 'EOF'
        {
          "hi": ["Hello! üëã", "Hi there! üòä", "Assalamualaikum! ü§≤"],
          "how are you": ["I'm fine, thank you! üòä", "Alhamdulillah, I'm good! üåü"],
          "thank you": ["You're welcome! üòä", "My pleasure! üåü"],
          "bye": ["Goodbye! üëã", "Take care! üòä"]
        }
        EOF
        
        # Bad words list
        echo '["bad", "abusive", "‡¶Ö‡¶™‡¶∂‡¶¨‡ßç‡¶¶"]' > data/moderation/bad-words.json
        
        # Welcome templates
        cat > data/welcome/templates.json << 'EOF'
        {
          "group": ["üéâ Welcome {name} to {group}! üåü"],
          "private": ["üëã Hello {name}! I'm Group Master Bot! ü§ñ"]
        }
        EOF
        
        echo "‚úÖ Default data files created"
        
    - name: Create main bot file
      run: |
        echo "ü§ñ Creating main bot file..."
        
        # Simple bot code for GitHub Actions
        cat > bot-simple.js << 'EOF'
        const TelegramBot = require('node-telegram-bot-api');
        const fs = require('fs');
        
        // Load config
        const config = JSON.parse(fs.readFileSync('config.json', 'utf8'));
        const token = config.bot.token;
        
        // Create bot
        const bot = new TelegramBot(token, { polling: true });
        
        console.log('üöÄ Bot started on GitHub Actions');
        console.log('ü§ñ Bot Username: ' + config.bot.username);
        console.log('üì± Mode: Polling');
        
        // Basic commands
        bot.onText(/\/start/, (msg) => {
          bot.sendMessage(msg.chat.id, 
            `üéâ Welcome to Group Master Bot!\n\n` +
            `Running on: GitHub Actions üöÄ\n` +
            `Status: Online ‚úÖ\n\n` +
            `Use /help for commands`
          );
        });
        
        bot.onText(/\/help/, (msg) => {
          bot.sendMessage(msg.chat.id,
            `üìö Available Commands:\n\n` +
            `/start - Start bot\n` +
            `/help - This message\n` +
            `/ping - Check bot status\n` +
            `/status - Detailed status\n` +
            `/id - Get chat ID\n\n` +
            `ü§ñ Bot runs on GitHub Actions\n` +
            `üîÑ Auto-restarts every 30 minutes`
          );
        });
        
        bot.onText(/\/ping/, (msg) => {
          bot.sendMessage(msg.chat.id, 'üèì Pong! Bot is alive on GitHub Actions');
        });
        
        bot.onText(/\/status/, (msg) => {
          const uptime = process.uptime();
          const hours = Math.floor(uptime / 3600);
          const minutes = Math.floor((uptime % 3600) / 60);
          const seconds = Math.floor(uptime % 60);
          
          bot.sendMessage(msg.chat.id,
            `üìä Bot Status:\n\n` +
            `‚Ä¢ Platform: GitHub Actions\n` +
            `‚Ä¢ Uptime: ${hours}h ${minutes}m ${seconds}s\n` +
            `‚Ä¢ Memory: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB\n` +
            `‚Ä¢ Node: ${process.version}\n` +
            `‚Ä¢ Mode: Polling\n` +
            `‚Ä¢ Status: ‚úÖ Running\n\n` +
            `üîÑ Auto-restart in: ${29 - Math.floor(uptime / 60)} minutes`
          );
        });
        
        bot.onText(/\/id/, (msg) => {
          bot.sendMessage(msg.chat.id,
            `üìã Chat Information:\n\n` +
            `Your ID: ${msg.from.id}\n` +
            `Chat ID: ${msg.chat.id}\n` +
            `Type: ${msg.chat.type}\n` +
            `Username: ${msg.from.username || 'No username'}\n` +
            `Name: ${msg.from.first_name} ${msg.from.last_name || ''}`
          );
        });
        
        // Auto-reply for private chats
        bot.on('message', (msg) => {
          if (!msg.text || msg.text.startsWith('/')) return;
          
          const message = msg.text.toLowerCase();
          
          // Auto-reply logic
          if (msg.chat.type === 'private') {
            if (message.includes('hello') || message.includes('hi') || message.includes('assalamualaikum')) {
              bot.sendMessage(msg.chat.id, 'Hello! üëã How can I help you?');
            }
            else if (message.includes('how are you')) {
              bot.sendMessage(msg.chat.id, 'I\'m fine, thank you! Running on GitHub Actions üòä');
            }
            else if (message.includes('thank you')) {
              bot.sendMessage(msg.chat.id, 'You\'re welcome! üòä');
            }
            else if (message.includes('bot')) {
              bot.sendMessage(msg.chat.id, 'Yes, I\'m a bot running on GitHub Actions! ü§ñ');
            }
          }
        });
        
        // Welcome new members
        bot.on('new_chat_members', (msg) => {
          msg.new_chat_members.forEach((member) => {
            if (!member.is_bot) {
              bot.sendMessage(msg.chat.id,
                `üéâ Welcome ${member.first_name} to the group!\n\n` +
                `I'm Group Master Bot running on GitHub Actions! ü§ñ`
              );
            }
          });
        });
        
        // Handle errors
        bot.on('polling_error', (error) => {
          console.error('Polling error:', error.message);
        });
        
        bot.on('error', (error) => {
          console.error('Bot error:', error.message);
        });
        
        // Graceful shutdown
        process.on('SIGTERM', () => {
          console.log('Received SIGTERM, shutting down...');
          bot.stopPolling();
          process.exit(0);
        });
        EOF
        
        echo "‚úÖ Bot file created"
        
    - name: Run the bot
      env:
        NODE_ENV: production
      run: |
        echo "üöÄ Starting Telegram Bot..."
        echo "‚è∞ Will run for 28 minutes (GitHub Actions limit)"
        echo "üì± Bot Token: ${BOT_TOKEN:0:10}..."  # ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡ßß‡ß¶‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∂‡ßã ‡¶ï‡¶∞‡¶¨‡ßá
        
        # Run bot with timeout
        timeout 28m node bot-simple.js
        
        echo "üîÑ Bot session ended, next run in 2 minutes"
        
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        # ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶®‡¶∏‡¶ø‡¶ü‡¶ø‡¶≠ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
        rm -f config.json
        echo "‚úÖ Cleanup complete"
