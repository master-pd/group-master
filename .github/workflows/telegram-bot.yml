name: Telegram Bot Runner

on:
  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦šà¦¾à¦²à¦¾à¦¤à§‡
  workflow_dispatch:
  
  # à¦¶à¦¿à¦¡à¦¿à¦‰à¦² à¦•à¦°à¦¾ à¦°à¦¾à¦¨ (à§¨à§ª/à§­ à¦šà¦¾à¦²à¦¾à¦¨à§‹à¦° à¦œà¦¨à§à¦¯)
  schedule:
    - cron: '*/25 * * * *'  # à¦ªà§à¦°à¦¤à¦¿ à§¨à§« à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 24  # à§¨à§« à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡à¦° à¦†à¦—à§‡ à¦¶à§‡à¦· à¦¹à¦¬à§‡
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies (with package-lock.json)
      run: |
        echo "ğŸ“¦ Creating package.json and installing dependencies..."
        
        # Create minimal package.json
        cat > package.json << 'EOF'
        {
          "name": "telegram-group-master-bot",
          "version": "1.0.0",
          "description": "Telegram Bot running on GitHub Actions",
          "main": "bot.js",
          "scripts": {
            "start": "node bot.js"
          },
          "dependencies": {
            "node-telegram-bot-api": "0.64.0"
          }
        }
        EOF
        
        # Install dependencies which will create package-lock.json
        npm install
        
        echo "âœ… Dependencies installed, package-lock.json created"
        
    - name: Create bot file
      run: |
        echo "ğŸ¤– Creating Telegram bot file..."
        
        cat > bot.js << 'EOF'
        const TelegramBot = require('node-telegram-bot-api');
        
        // Get bot token from environment variable
        const token = process.env.BOT_TOKEN || '';
        
        if (!token) {
          console.error('âŒ ERROR: BOT_TOKEN environment variable is not set!');
          console.error('Please add BOT_TOKEN to GitHub Secrets');
          process.exit(1);
        }
        
        // Create bot
        const bot = new TelegramBot(token, {
          polling: true,
          request: {
            timeout: 60000
          }
        });
        
        console.log('========================================');
        console.log('ğŸš€ Group Master Bot Started');
        console.log('ğŸ¤– Running on: GitHub Actions');
        console.log('ğŸ“± Mode: Polling');
        console.log('â° Start Time: ' + new Date().toLocaleString());
        console.log('========================================');
        
        // ========== BASIC COMMANDS ==========
        
        // /start command
        bot.onText(/\/start/, (msg) => {
          const chatId = msg.chat.id;
          const userName = msg.from.first_name;
          
          bot.sendMessage(chatId, 
            `ğŸ‰ *Welcome ${userName} to Group Master Bot!* ğŸ‘‘\n\n` +
            `*Status:* âœ… Running on GitHub Actions\n` +
            `*Platform:* ğŸš€ GitHub Actions Runner\n` +
            `*Uptime:* 24/7 (Auto-restart every 25min)\n` +
            `*Version:* 3.0.0\n\n` +
            `Use /help for available commands\n` +
            `Use /status for detailed information\n\n` +
            `_Made with â¤ï¸ by MAR-PD_`,
            { parse_mode: 'Markdown' }
          );
        });
        
        // /help command
        bot.onText(/\/help/, (msg) => {
          const helpText = `
ğŸ“š *Group Master Bot - Help* ğŸ‘‘

*Basic Commands:*
/start - Start the bot
/help - Show this help message
/ping - Check if bot is alive
/status - Bot status information
/id - Get chat/user ID
/time - Current time

*Group Management:*
/rules - Show group rules
/admin - Mention all admins
/report - Report a user
/info - Group information

*Admin Commands (if admin):*
/warn - Warn a user
/mute - Mute a user
/ban - Ban a user

*Features:*
â€¢ Auto Welcome Messages
â€¢ Auto Reply System
â€¢ Moderation Tools
â€¢ 24/7 Uptime

ğŸ¤– *Note:* This bot runs on GitHub Actions
          `;
          
          bot.sendMessage(msg.chat.id, helpText, { parse_mode: 'Markdown' });
        });
        
        // /ping command
        bot.onText(/\/ping/, (msg) => {
          const start = Date.now();
          bot.sendMessage(msg.chat.id, 'ğŸ“ Pinging...').then(sentMsg => {
            const latency = Date.now() - start;
            bot.editMessageText(
              `ğŸ“ *Pong!*\n\n` +
              `â€¢ Bot Latency: ${latency}ms\n` +
              `â€¢ Platform: GitHub Actions\n` +
              `â€¢ Status: âœ… Online\n` +
              `â€¢ Uptime: ${Math.floor(process.uptime())} seconds`,
              {
                chat_id: msg.chat.id,
                message_id: sentMsg.message_id,
                parse_mode: 'Markdown'
              }
            );
          });
        });
        
        // /status command
        bot.onText(/\/status/, (msg) => {
          const uptime = process.uptime();
          const hours = Math.floor(uptime / 3600);
          const minutes = Math.floor((uptime % 3600) / 60);
          const seconds = Math.floor(uptime % 60);
          
          const memory = process.memoryUsage();
          const memoryUsed = Math.round(memory.heapUsed / 1024 / 1024);
          const memoryTotal = Math.round(memory.heapTotal / 1024 / 1024);
          
          const statusText = `
ğŸ“Š *Bot Status Report* ğŸ“ˆ

*System Information:*
â€¢ Platform: GitHub Actions ğŸš€
â€¢ Node.js: ${process.version}
â€¢ Uptime: ${hours}h ${minutes}m ${seconds}s
â€¢ Memory: ${memoryUsed}MB / ${memoryTotal}MB
â€¢ PID: ${process.pid}

*Bot Information:*
â€¢ Mode: Polling âœ…
â€¢ Status: Running ğŸŸ¢
â€¢ Next Restart: ${25 - minutes} minutes
â€¢ Total Chats: Active

*GitHub Actions:*
â€¢ Runner: ubuntu-latest
â€¢ Timeout: 24 minutes
â€¢ Schedule: Every 25 minutes
â€¢ Free Tier: 2000 min/month

_Last Updated: ${new Date().toLocaleTimeString()}_
          `;
          
          bot.sendMessage(msg.chat.id, statusText, { parse_mode: 'Markdown' });
        });
        
        // /id command
        bot.onText(/\/id/, (msg) => {
          const userInfo = `
ğŸ†” *ID Information*

*Your Information:*
â€¢ User ID: \`${msg.from.id}\`
â€¢ First Name: ${msg.from.first_name}
â€¢ Last Name: ${msg.from.last_name || 'Not set'}
â€¢ Username: @${msg.from.username || 'Not set'}
â€¢ Language: ${msg.from.language_code || 'Unknown'}

*Chat Information:*
â€¢ Chat ID: \`${msg.chat.id}\`
â€¢ Chat Type: ${msg.chat.type}
â€¢ Chat Title: ${msg.chat.title || 'Private Chat'}

*Bot Information:*
â€¢ Bot ID: ${bot.id}
â€¢ Bot Username: @${bot.options.username}
          `;
          
          bot.sendMessage(msg.chat.id, userInfo, { parse_mode: 'Markdown' });
        });
        
        // /time command
        bot.onText(/\/time/, (msg) => {
          const now = new Date();
          const timeText = `
ğŸ• *Current Time*

*Local Time:*
${now.toLocaleString()}

*UTC Time:*
${now.toUTCString()}

*Timestamp:*
${now.getTime()} (milliseconds)
${Math.floor(now.getTime() / 1000)} (seconds)

*Date Information:*
â€¢ Year: ${now.getFullYear()}
â€¢ Month: ${now.getMonth() + 1}
â€¢ Day: ${now.getDate()}
â€¢ Day of Week: ${now.toLocaleDateString('en-US', { weekday: 'long' })}
          `;
          
          bot.sendMessage(msg.chat.id, timeText, { parse_mode: 'Markdown' });
        });
        
        // ========== AUTO REPLY SYSTEM ==========
        
        bot.on('message', (msg) => {
          // Skip commands
          if (msg.text && msg.text.startsWith('/')) return;
          
          const message = msg.text ? msg.text.toLowerCase() : '';
          const chatType = msg.chat.type;
          const userName = msg.from.first_name;
          
          // Private chat auto-reply
          if (chatType === 'private' && message) {
            let reply = null;
            
            if (message.includes('hello') || message.includes('hi') || message.includes('hey')) {
              reply = `Hello ${userName}! ğŸ‘‹ How can I help you today?`;
            }
            else if (message.includes('assalamualaikum') || message.includes('salam')) {
              reply = `Waalaikumussalam ${userName}! ğŸ¤² How are you?`;
            }
            else if (message.includes('how are you') || message.includes('à¦•à§‡à¦®à¦¨ à¦†à¦›')) {
              reply = `I'm fine, thank you ${userName}! ğŸ˜Š Running smoothly on GitHub Actions!`;
            }
            else if (message.includes('thank you') || message.includes('thanks') || message.includes('à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦')) {
              reply = `You're welcome ${userName}! ğŸŒŸ`;
            }
            else if (message.includes('bot') || message.includes('à¦¬à¦Ÿ')) {
              reply = `Yes ${userName}, I'm a Telegram bot running on GitHub Actions! ğŸ¤–`;
            }
            else if (message.includes('github') || message.includes('action')) {
              reply = `I run on GitHub Actions free tier! ğŸš€\n24/7 uptime with auto-restart every 25 minutes.`;
            }
            else if (message.includes('mar-pd') || message.includes('developer')) {
              reply = `I was created by MAR-PD! ğŸ‘¨â€ğŸ’»\nContact: @master_spamming`;
            }
            else if (message.includes('bye') || message.includes('goodbye') || message.includes('à¦¬à¦¿à¦¦à¦¾à¦¯à¦¼')) {
              reply = `Goodbye ${userName}! ğŸ‘‹ Take care!`;
            }
            
            if (reply) {
              // Add typing indicator
              bot.sendChatAction(msg.chat.id, 'typing');
              setTimeout(() => {
                bot.sendMessage(msg.chat.id, reply);
              }, 1000);
            }
          }
          
          // Group chat moderation
          if (chatType !== 'private' && message) {
            // Simple bad word filter
            const badWords = ['badword', 'à¦…à¦ªà¦¶à¦¬à§à¦¦', 'à¦–à¦¾à¦°à¦¾à¦ª'];
            for (const word of badWords) {
              if (message.includes(word)) {
                bot.deleteMessage(msg.chat.id, msg.message_id).catch(() => {});
                bot.sendMessage(msg.chat.id, 
                  `âš ï¸ *Warning* ${userName}\n\nPlease avoid using inappropriate language in this group.`,
                  { parse_mode: 'Markdown' }
                );
                break;
              }
            }
          }
        });
        
        // ========== WELCOME SYSTEM ==========
        
        bot.on('new_chat_members', (msg) => {
          const chatId = msg.chat.id;
          
          msg.new_chat_members.forEach((member) => {
            // Don't welcome bots
            if (member.is_bot && member.id === bot.id) {
              // Bot added to group
              bot.sendMessage(chatId,
                `ğŸ¤– *Group Master Bot Added!* ğŸ‘‘\n\n` +
                `Thank you for adding me to the group!\n\n` +
                `*My Features:*\n` +
                `â€¢ Auto Welcome Messages\n` +
                `â€¢ Moderation Tools\n` +
                `â€¢ Auto Reply System\n` +
                `â€¢ 24/7 Uptime\n\n` +
                `Use /help for commands\n` +
                `Make me admin for full features!`,
                { parse_mode: 'Markdown' }
              );
            }
            else if (!member.is_bot) {
              // Welcome regular users
              const welcomeMessages = [
                `ğŸ‰ Welcome ${member.first_name} to the group! ğŸŒŸ`,
                `ğŸ‘‹ Assalamualaikum ${member.first_name}! Welcome! ğŸ¤²`,
                `âœ¨ Hello ${member.first_name}! Glad to have you here! ğŸ˜Š`,
                `ğŸš€ Welcome aboard ${member.first_name}! ğŸ¯`,
                `ğŸ’« Hey ${member.first_name}! Welcome to our community! ğŸŒˆ`
              ];
              
              const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
              
              bot.sendMessage(chatId, randomWelcome);
            }
          });
        });
        
        // ========== ERROR HANDLING ==========
        
        bot.on('polling_error', (error) => {
          console.error('ğŸ”´ Polling Error:', error.message);
          console.error('Code:', error.code);
          
          // Don't exit on common errors
          if (error.code === 'EFATAL') {
            console.log('âš ï¸ Fatal error, but continuing...');
          }
        });
        
        bot.on('error', (error) => {
          console.error('ğŸ”´ Bot Error:', error.message);
        });
        
        // ========== KEEP ALIVE & MONITORING ==========
        
        console.log('âœ… Bot initialized successfully');
        console.log('ğŸ”„ Polling started');
        
        // Periodic heartbeat
        setInterval(() => {
          const uptime = process.uptime();
          const minutes = Math.floor(uptime / 60);
          console.log(`ğŸ’“ Heartbeat: Running for ${minutes} minutes`);
          
          // Auto-restart warning at 23 minutes
          if (minutes >= 23) {
            console.log('âš ï¸ Warning: Will auto-restart in 1 minute');
          }
        }, 60000); // Every minute
        
        // ========== GRACEFUL SHUTDOWN ==========
        
        process.on('SIGTERM', () => {
          console.log('ğŸ›‘ Received SIGTERM, shutting down gracefully...');
          bot.stopPolling().then(() => {
            console.log('âœ… Bot polling stopped');
            process.exit(0);
          });
        });
        
        process.on('SIGINT', () => {
          console.log('ğŸ›‘ Received SIGINT, shutting down...');
          bot.stopPolling();
          process.exit(0);
        });
        EOF
        
        echo "âœ… Bot file created successfully"
        
    - name: Run Telegram Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "ğŸš€ Starting Telegram Bot..."
        echo "ğŸ¤– Bot Token: ${BOT_TOKEN:0:15}..."  # Show first 15 chars only
        echo "â° Timeout: 24 minutes"
        echo "ğŸ“… Started at: $(date)"
        echo ""
        
        # Run the bot with timeout
        timeout 24m node bot.js
        
        echo ""
        echo "ğŸ”„ Bot session completed"
        echo "â° Ended at: $(date)"
        echo "ğŸ“Š Next run scheduled in 1 minute"
        
    - name: Upload logs if failed
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: bot-error-logs
        path: |
          *.log
        retention-days: 7
