name: Telegram Bot Runner

on:
  workflow_dispatch:  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦šà¦¾à¦²à¦¾à¦¤à§‡
  schedule:
    # à¦ªà§à¦°à¦¤à¦¿ à§¨à§« à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡ à¦šà¦¾à¦²à¦¾à¦¬à§‡ (à§¨à§ª/à§­ à¦à¦° à¦œà¦¨à§à¦¯)
    - cron: '*/25 * * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 24  # à§¨à§« à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡à¦° à¦†à¦—à§‡ à¦¶à§‡à¦· à¦¹à¦¬à§‡
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"
        
    - name: Create bot file
      run: |
        echo "ğŸ¤– Creating bot.js file..."
        
        cat > bot.js << 'EOF'
        const TelegramBot = require('node-telegram-bot-api');
        
        // Get bot token from environment
        const token = process.env.BOT_TOKEN;
        
        if (!token) {
          console.error('âŒ ERROR: BOT_TOKEN is not set!');
          console.error('Please add BOT_TOKEN to GitHub Secrets');
          process.exit(1);
        }
        
        // Create bot instance
        const bot = new TelegramBot(token, {
          polling: true,
          request: {
            timeout: 60000
          }
        });
        
        console.log('========================================');
        console.log('ğŸš€ GROUP MASTER BOT STARTED');
        console.log('ğŸ“± Running on: GitHub Actions');
        console.log('â° Started at: ' + new Date().toLocaleString());
        console.log('========================================');
        
        // ================= BASIC COMMANDS =================
        
        // /start command
        bot.onText(/\/start/, (msg) => {
          const response = `
ğŸ‰ *Welcome to Group Master Bot!* ğŸ‘‘

*Status:* âœ… Running on GitHub Actions
*Uptime:* 24/7 (Auto-restart every 25min)
*Platform:* ğŸš€ GitHub Actions Runner
*Version:* 3.0.0

*Available Commands:*
/start - Start the bot
/help - Show help
/ping - Check status
/id - Get chat ID
/time - Current time

*Features:*
â€¢ Auto Welcome Messages
â€¢ Auto Reply System
â€¢ Basic Moderation
â€¢ 24/7 Uptime

_Made with â¤ï¸ by MAR-PD_
          `;
          
          bot.sendMessage(msg.chat.id, response, { parse_mode: 'Markdown' });
        });
        
        // /help command
        bot.onText(/\/help/, (msg) => {
          const helpText = `
ğŸ“š *Group Master Bot Help* ğŸ¤–

*Basic Commands:*
/start - Start bot
/help - Show this help
/ping - Check bot status
/status - Detailed status
/id - Get chat/user ID
/time - Current time

*Group Commands:*
/rules - Show group rules
/admin - Mention all admins
/report - Report a user

*Features:*
âœ… Auto Welcome Messages
âœ… Auto Reply System
âœ… Basic Moderation
âœ… 24/7 Uptime

*Note:* This bot runs on GitHub Actions
Free tier: 2000 minutes/month
          `;
          
          bot.sendMessage(msg.chat.id, helpText, { parse_mode: 'Markdown' });
        });
        
        // /ping command
        bot.onText(/\/ping/, (msg) => {
          bot.sendMessage(msg.chat.id, 'ğŸ“ Pong! Bot is alive and running on GitHub Actions! âœ…');
        });
        
        // /status command
        bot.onText(/\/status/, (msg) => {
          const uptime = process.uptime();
          const hours = Math.floor(uptime / 3600);
          const minutes = Math.floor((uptime % 3600) / 60);
          const seconds = Math.floor(uptime % 60);
          
          const memory = Math.round(process.memoryUsage().heapUsed / 1024 / 1024);
          
          const status = `
ğŸ“Š *Bot Status Report*

*System Info:*
â€¢ Platform: GitHub Actions ğŸš€
â€¢ Node.js: ${process.version}
â€¢ Uptime: ${hours}h ${minutes}m ${seconds}s
â€¢ Memory: ${memory}MB used
â€¢ Restart in: ${25 - minutes} minutes

*Bot Info:*
â€¢ Status: âœ… Running
â€¢ Mode: Polling
â€¢ Version: 3.0.0
â€¢ Developer: MAR-PD

*GitHub Actions:*
â€¢ Runner: ubuntu-latest
â€¢ Schedule: Every 25 minutes
â€¢ Max Duration: 24 minutes
â€¢ Free Minutes: 2000/month

_Last update: ${new Date().toLocaleTimeString()}_
          `;
          
          bot.sendMessage(msg.chat.id, status, { parse_mode: 'Markdown' });
        });
        
        // /id command
        bot.onText(/\/id/, (msg) => {
          const idInfo = `
ğŸ†” *ID Information*

*Your Info:*
â€¢ User ID: \`${msg.from.id}\`
â€¢ Name: ${msg.from.first_name} ${msg.from.last_name || ''}
â€¢ Username: @${msg.from.username || 'Not set'}

*Chat Info:*
â€¢ Chat ID: \`${msg.chat.id}\`
â€¢ Type: ${msg.chat.type}
â€¢ Title: ${msg.chat.title || 'Private Chat'}
          `;
          
          bot.sendMessage(msg.chat.id, idInfo, { parse_mode: 'Markdown' });
        });
        
        // /time command
        bot.onText(/\/time/, (msg) => {
          const now = new Date();
          const timeInfo = `
ğŸ• *Current Time*

*Local Time:*
${now.toLocaleString()}

*UTC Time:*
${now.toUTCString()}

*Timestamp:*
${Math.floor(now.getTime() / 1000)} seconds
${now.getTime()} milliseconds

*Date:*
${now.toDateString()}
          `;
          
          bot.sendMessage(msg.chat.id, timeInfo, { parse_mode: 'Markdown' });
        });
        
        // /rules command
        bot.onText(/\/rules/, (msg) => {
          const rules = `
ğŸ“œ *Group Rules*

1. Be respectful to everyone
2. No spam or flooding
3. No inappropriate content
4. No unauthorized links
5. Follow admin instructions
6. Use appropriate language
7. No personal attacks
8. Keep discussions civil

âœ… *These rules apply to everyone.*
          `;
          
          bot.sendMessage(msg.chat.id, rules, { parse_mode: 'Markdown' });
        });
        
        // ================= AUTO REPLY =================
        
        bot.on('message', (msg) => {
          // Skip commands
          if (msg.text && msg.text.startsWith('/')) return;
          
          const text = msg.text ? msg.text.toLowerCase() : '';
          const name = msg.from.first_name;
          
          // Private chat auto-reply
          if (msg.chat.type === 'private' && text) {
            let reply = null;
            
            if (text.includes('hello') || text.includes('hi') || text.includes('hey')) {
              reply = `Hello ${name}! ğŸ‘‹ How can I help you?`;
            }
            else if (text.includes('assalamualaikum') || text.includes('salam')) {
              reply = `Waalaikumussalam ${name}! ğŸ¤²`;
            }
            else if (text.includes('how are you')) {
              reply = `I'm fine ${name}, thank you! Running on GitHub Actions ğŸ˜Š`;
            }
            else if (text.includes('thank you') || text.includes('thanks')) {
              reply = `You're welcome ${name}! ğŸ˜Š`;
            }
            else if (text.includes('bot')) {
              reply = `Yes ${name}, I'm a Telegram bot running on GitHub Actions! ğŸ¤–`;
            }
            else if (text.includes('github')) {
              reply = `I run on GitHub Actions free tier! ğŸš€\n2000 minutes/month, 24/7 uptime!`;
            }
            else if (text.includes('mar-pd')) {
              reply = `I was created by MAR-PD! ğŸ‘¨â€ğŸ’»\nTelegram: @master_spamming`;
            }
            
            if (reply) {
              bot.sendChatAction(msg.chat.id, 'typing');
              setTimeout(() => {
                bot.sendMessage(msg.chat.id, reply);
              }, 1000);
            }
          }
          
          // Group chat - simple moderation
          if (msg.chat.type !== 'private' && text) {
            const badWords = ['badword', 'à¦…à¦ªà¦¶à¦¬à§à¦¦', 'à¦–à¦¾à¦°à¦¾à¦ª'];
            for (const word of badWords) {
              if (text.includes(word)) {
                bot.sendMessage(msg.chat.id, 
                  `âš ï¸ ${name}, please avoid using inappropriate language!`
                );
                break;
              }
            }
          }
        });
        
        // ================= WELCOME SYSTEM =================
        
        bot.on('new_chat_members', (msg) => {
          msg.new_chat_members.forEach((member) => {
            if (member.is_bot && member.id === bot.id) {
              // Bot added to group
              bot.sendMessage(msg.chat.id,
                `ğŸ¤– *Group Master Bot Added!* ğŸ‰\n\n` +
                `Thanks for adding me! I can help with:\n` +
                `â€¢ Welcome messages\n` +
                `â€¢ Basic moderation\n` +
                `â€¢ Auto replies\n` +
                `â€¢ Group management\n\n` +
                `Use /help for commands\n` +
                `Make me admin for full features!`,
                { parse_mode: 'Markdown' }
              );
            }
            else if (!member.is_bot) {
              // Welcome regular users
              const welcomes = [
                `ğŸ‰ Welcome ${member.first_name} to the group! ğŸŒŸ`,
                `ğŸ‘‹ Hello ${member.first_name}! Glad to have you! ğŸ˜Š`,
                `ğŸš€ Welcome aboard ${member.first_name}! ğŸ¯`,
                `âœ¨ Assalamualaikum ${member.first_name}! Welcome! ğŸ¤²`
              ];
              
              const welcomeMsg = welcomes[Math.floor(Math.random() * welcomes.length)];
              bot.sendMessage(msg.chat.id, welcomeMsg);
            }
          });
        });
        
        // ================= ERROR HANDLING =================
        
        bot.on('polling_error', (error) => {
          console.error('ğŸ”´ Polling Error:', error.message);
        });
        
        bot.on('error', (error) => {
          console.error('ğŸ”´ Bot Error:', error.message);
        });
        
        // ================= HEARTBEAT =================
        
        console.log('âœ… Bot initialized successfully');
        
        // Show heartbeat every minute
        setInterval(() => {
          const uptime = process.uptime();
          const min = Math.floor(uptime / 60);
          console.log(`ğŸ’“ Heartbeat: Running for ${min} minutes`);
          
          if (min >= 23) {
            console.log('âš ï¸ Will auto-restart in 1 minute');
          }
        }, 60000);
        
        // ================= GRACEFUL SHUTDOWN =================
        
        process.on('SIGTERM', () => {
          console.log('ğŸ›‘ Shutting down gracefully...');
          bot.stopPolling();
          process.exit(0);
        });
        EOF
        
        echo "âœ… bot.js file created"
        
    - name: Run Telegram Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "ğŸš€ Starting Telegram Bot..."
        echo "â° Will run for 24 minutes"
        echo "ğŸ“… Started at: $(date)"
        echo ""
        
        # Run bot with timeout
        timeout 24m node bot.js
        
        echo ""
        echo "âœ… Bot session completed successfully"
        echo "â° Ended at: $(date)"
        echo "ğŸ”„ Next run scheduled in 1 minute"
