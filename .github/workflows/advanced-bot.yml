name: Advanced Bot Runner

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours

env:
  NODE_VERSION: '18'
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        npm install 
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libcairo2-dev \
          libpango1.0-dev \
          libjpeg-dev \
          libgif-dev \
          librsvg2-dev
    
    - name: âš™ï¸ Create configuration
      run: |
        cat > config.json << EOF
        {
          "botToken": "${{ secrets.BOT_TOKEN }}",
          "developerId": [${{ secrets.DEVELOPER_ID }}],
          "botName": "Group Master",
          "maxWelcomeMessages": 10,
          "spamThreshold": {
            "messages": 10,
            "seconds": 5,
            "muteDuration": 120
          },
          "contact": "https://t.me/master_spamming",
          "watermark": "Group Master Bot",
          "features": {
            "autoWelcome": true,
            "autoReply": true,
            "spamProtection": true,
            "urlProtection": true,
            "badWordFilter": true
          }
        }
        EOF
        
        echo "Configuration created successfully!"
        cat config.json
    
    - name: ðŸ§ª Run tests
      run: |
        if [ -f scripts/test-bot.js ]; then
          node scripts/test-bot.js
        else
          echo "No test script found, skipping tests"
        fi
    
    - name: ðŸš€ Start Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "ðŸ¤– Starting Group Master Bot..."
        timeout 10s node setup.js || true
        echo "ðŸ”§ Initial test completed, starting main process..."
        node index.js &
        sleep 5
        echo "âœ… Bot process started successfully!"
        echo "ðŸ“ž Contact: https://t.me/master_spamming"
    
    - name: ðŸ“Š Health check
      run: |
        echo "Bot deployment completed at: $(date)"
        echo "GitHub Actions Runner: ${{ runner.os }}"
        echo "Node.js Version: $(node --version)"
        echo "NPM Version: $(npm --version)"
