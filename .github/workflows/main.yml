name: ЁЯЪА Telegram Bot Runner

on:
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ ржЪрж╛рж▓рж╛рждрзЗ
  schedule:
    # ржкрзНрж░рждрж┐ рзирзл ржорж┐ржирж┐ржЯрзЗ рж░рж╛ржи ржХрж░ржмрзЗ (рзирзк/рзн)
    - cron: '*/25 * * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 24  # рзирзл ржорж┐ржирж┐ржЯрзЗрж░ ржЖржЧрзЗ рж╢рзЗрж╖ рж╣ржмрзЗ
    
    steps:
    # рзз. ржХрзЛржб ржЪрзЗржХржЖржЙржЯ
    - name: ЁЯУе Checkout Repository
      uses: actions/checkout@v4
      
    # рзи. Node.js рж╕рзЗржЯржЖржк
    - name: тЪЩя╕П Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    # рзй. package.json рждрзИрж░рж┐
    - name: ЁЯУж Create Package Files
      run: |
        echo "Creating package.json..."
        cat > package.json <<-EOF
        {
          "name": "group-master-bot",
          "version": "1.0.0",
          "description": "Telegram Bot running on GitHub Actions",
          "main": "bot.js",
          "scripts": {
            "start": "node bot.js"
          },
          "dependencies": {
            "node-telegram-bot-api": "^0.64.0"
          },
          "engines": {
            "node": ">=16.0.0"
          }
        }
        EOF
        
        echo "Creating package-lock.json..."
        cat > package-lock.json <<-EOF
        {
          "name": "group-master-bot",
          "version": "1.0.0",
          "lockfileVersion": 3,
          "requires": true,
          "packages": {
            "": {
              "name": "group-master-bot",
              "version": "1.0.0",
              "dependencies": {
                "node-telegram-bot-api": "^0.64.0"
              }
            },
            "node_modules/node-telegram-bot-api": {
              "version": "0.64.0",
              "resolved": "https://registry.npmjs.org/node-telegram-bot-api/-/node-telegram-bot-api-0.64.0.tgz",
              "integrity": "sha512-wY6aQKbMBBW7wL7kJVM2YJ5tTUK0R2YLhggqjNjACGR7xO8HJLv5iBq1O/4vVqnkHGc9JxRpGZbwqCRpK5GhlA=="
            }
          }
        }
        EOF
        
        echo "тЬЕ Package files created"
        
    # рзк. ржбрж┐ржкрзЗржирзНржбрзЗржирзНрж╕рж┐ ржЗржирзНрж╕ржЯрж▓
    - name: ЁЯУе Install Dependencies
      run: npm install
      
    # рзл. ржмржЯ ржлрж╛ржЗрж▓ рждрзИрж░рж┐
    - name: ЁЯдЦ Create Bot File
      run: |
        echo "Creating bot.js..."
        cat > bot.js <<-EOF
        const TelegramBot = require('node-telegram-bot-api');
        
        // ржЯрзЛржХрзЗржи ржЪрзЗржХ
        const token = process.env.BOT_TOKEN;
        if (!token) {
          console.error('тЭМ BOT_TOKEN missing! Add to GitHub Secrets');
          process.exit(1);
        }
        
        // ржмржЯ рждрзИрж░рж┐
        const bot = new TelegramBot(token, { polling: true });
        
        console.log('==========================================');
        console.log('ЁЯдЦ GROUP MASTER BOT STARTED');
        console.log('ЁЯЪА Running on GitHub Actions');
        console.log('тП░ Started: ' + new Date().toLocaleString());
        console.log('==========================================');
        
        // рзз. /start ржХржорж╛ржирзНржб
        bot.onText(/\/start/, (msg) => {
          const text = \`
ЁЯОЙ *Welcome to Group Master Bot!*

*Status:* тЬЕ Running on GitHub Actions
*Uptime:* 24/7 (Auto-restart every 25min)
*Platform:* ЁЯЪА GitHub Actions Runner

*Commands:*
/start - Start bot
/help - Show help
/ping - Check status
/id - Get chat ID
/time - Current time

*Features:*
тАв Auto Welcome Messages
тАв Auto Reply System
тАв Basic Moderation
тАв 24/7 Uptime

_Created by MAR-PD_
          \`;
          bot.sendMessage(msg.chat.id, text, { parse_mode: 'Markdown' });
        });
        
        // рзи. /help ржХржорж╛ржирзНржб
        bot.onText(/\/help/, (msg) => {
          const text = \`
ЁЯУЪ *Available Commands*

/start - Start the bot
/help - This help message
/ping - Check if bot is alive
/id - Get your chat ID
/time - Current server time
/rules - Group rules
/status - Bot status info

*Auto Features:*
тЬЕ Auto welcome new members
тЬЕ Auto reply in private chat
тЬЕ Basic word filter
тЬЕ 24/7 uptime

ЁЯдЦ *Running on GitHub Actions*
          \`;
          bot.sendMessage(msg.chat.id, text, { parse_mode: 'Markdown' });
        });
        
        // рзй. /ping ржХржорж╛ржирзНржб
        bot.onText(/\/ping/, (msg) => {
          bot.sendMessage(msg.chat.id, 'ЁЯПУ Pong! Bot is running on GitHub Actions');
        });
        
        // рзк. /id ржХржорж╛ржирзНржб
        bot.onText(/\/id/, (msg) => {
          const text = \`
ЁЯЖФ *ID Information*

*User ID:* \\\`${msg.from.id}\\\`
*Chat ID:* \\\`${msg.chat.id}\\\`
*Name:* ${msg.from.first_name}
*Username:* ${msg.from.username ? '@' + msg.from.username : 'Not set'}
          \`;
          bot.sendMessage(msg.chat.id, text, { parse_mode: 'Markdown' });
        });
        
        // рзл. /time ржХржорж╛ржирзНржб
        bot.onText(/\/time/, (msg) => {
          const now = new Date();
          const text = \`
ЁЯХР *Current Time*

*Local:* ${now.toLocaleString()}
*UTC:* ${now.toUTCString()}
*Timestamp:* ${Math.floor(now.getTime() / 1000)}
          \`;
          bot.sendMessage(msg.chat.id, text, { parse_mode: 'Markdown' });
        });
        
        // рзм. /status ржХржорж╛ржирзНржб
        bot.onText(/\/status/, (msg) => {
          const uptime = process.uptime();
          const min = Math.floor(uptime / 60);
          const mem = Math.round(process.memoryUsage().heapUsed / 1024 / 1024);
          
          const text = \`
ЁЯУК *Bot Status*

*Uptime:* ${min} minutes
*Memory:* ${mem} MB
*Platform:* GitHub Actions
*Node.js:* ${process.version}
*Restart in:* ${25 - min} minutes
*Status:* тЬЕ Running
          \`;
          bot.sendMessage(msg.chat.id, text, { parse_mode: 'Markdown' });
        });
        
        // рзн. /rules ржХржорж╛ржирзНржб
        bot.onText(/\/rules/, (msg) => {
          const text = \`
ЁЯУЬ *Group Rules*

1я╕ПтГг Respect all members
2я╕ПтГг No spam or flood
3я╕ПтГг No inappropriate content
4я╕ПтГг No unauthorized links
5я╕ПтГг Follow admin instructions
6я╕ПтГг Keep discussions civil

тЬЕ *Rules apply to everyone*
          \`;
          bot.sendMessage(msg.chat.id, text, { parse_mode: 'Markdown' });
        });
        
        // ЁЯОп ржЕржЯрзЛ рж░рж┐ржкрзНрж▓рж╛ржЗ рж╕рж┐рж╕рзНржЯрзЗржо (ржкрзНрж░рж╛ржЗржнрзЗржЯ ржЪрзНржпрж╛ржЯ)
        bot.on('message', (msg) => {
          if (!msg.text || msg.text.startsWith('/')) return;
          
          const text = msg.text.toLowerCase();
          const name = msg.from.first_name;
          
          if (msg.chat.type === 'private') {
            let reply = null;
            
            if (text.includes('hello') || text.includes('hi') || text.includes('hey')) {
              reply = \`Hello ${name}! ЁЯСЛ\`;
            }
            else if (text.includes('assalamualaikum') || text.includes('salam')) {
              reply = \`Waalaikumussalam ${name}! ЁЯд▓\`;
            }
            else if (text.includes('how are you')) {
              reply = \`I'm fine ${name}, thank you! ЁЯШК\`;
            }
            else if (text.includes('thank you') || text.includes('thanks')) {
              reply = \`You're welcome ${name}! ЁЯШК\`;
            }
            else if (text.includes('bot')) {
              reply = \`Yes ${name}, I'm a Telegram bot! ЁЯдЦ\`;
            }
            else if (text.includes('github')) {
              reply = \`Running on GitHub Actions ЁЯЪА\`;
            }
            
            if (reply) {
              setTimeout(() => {
                bot.sendMessage(msg.chat.id, reply);
              }, 500);
            }
          }
        });
        
        // ЁЯОЙ ржУржпрж╝рзЗрж▓ржХрж╛ржо рж╕рж┐рж╕рзНржЯрзЗржо
        bot.on('new_chat_members', (msg) => {
          msg.new_chat_members.forEach((member) => {
            if (member.is_bot && member.id === bot.id) {
              bot.sendMessage(msg.chat.id,
                \`ЁЯдЦ *Bot Added Successfully!*\n\n\` +
                \`Thanks for adding me! Use /help for commands.\`,
                { parse_mode: 'Markdown' }
              );
            }
            else if (!member.is_bot) {
              const welcomes = [
                \`ЁЯОЙ Welcome ${member.first_name} to the group!\`,
                \`ЁЯСЛ Hello ${member.first_name}! Glad to have you!\`,
                \`ЁЯМЯ Welcome ${member.first_name}! Enjoy your stay.\`,
                \`ЁЯЪА ${member.first_name} joined the group! Welcome!\`
              ];
              const welcome = welcomes[Math.floor(Math.random() * welcomes.length)];
              bot.sendMessage(msg.chat.id, welcome);
            }
          });
        });
        
        // тЪая╕П ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВ
        bot.on('polling_error', (error) => {
          console.log('Polling error:', error.message);
        });
        
        bot.on('error', (error) => {
          console.log('Bot error:', error.message);
        });
        
        // ЁЯТУ рж╣рзГржжрж╕рзНржкржирзНржжржи рж▓ржЧ
        console.log('тЬЕ Bot ready to receive messages');
        setInterval(() => {
          const min = Math.floor(process.uptime() / 60);
          console.log(\`ЁЯТУ Running for ${min} minutes\`);
        }, 60000);
        EOF
        
        echo "тЬЕ bot.js created successfully"
        
    # рзм. ржмржЯ рж░рж╛ржи
    - name: ЁЯЪА Run Telegram Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "========================================"
        echo "ЁЯдЦ STARTING TELEGRAM BOT"
        echo "========================================"
        echo "Platform: GitHub Actions"
        echo "Timeout: 24 minutes"
        echo "Start: \$(date)"
        echo "========================================"
        
        # рзирзк ржорж┐ржирж┐ржЯрзЗрж░ ржЬржирзНржп ржмржЯ рж░рж╛ржи
        timeout 24m node bot.js
        
        echo "========================================"
        echo "тЬЕ BOT SESSION COMPLETED"
        echo "End: \$(date)"
        echo "Next run: In 1 minute"
        echo "========================================"
        
    # рзн. рж╕рж╛ржлрж▓рзНржп ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи
    - name: тЬЕ Success Notification
      if: success()
      run: |
        echo "ЁЯОЙ Bot ran successfully for 24 minutes"
        echo "ЁЯФД Will auto-restart in 1 minute"
        
    # рзо. ржлрзЗрж▓рж┐рзЯрж╛рж░ ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи
    - name: тЭМ Failure Notification
      if: failure()
      run: |
        echo "тЪая╕П Bot run failed!"
        echo "Check logs for details"
